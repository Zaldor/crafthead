import fs from 'node:fs/promises';
import path from 'node:path';

/**
 * Generates `dist/_worker.js` for Cloudflare Pages Advanced Mode.
 *
 * Why:
 * - Cloudflare Pages "direct upload" (drag & drop) does NOT support compiling a `functions/` directory.
 * - It DOES support a single `_worker.js` inside the build output directory.
 * - This worker implements Decap CMS GitHub OAuth endpoints and then falls back to `env.ASSETS.fetch()`.
 */

const distDir = path.resolve('dist');
const outFile = path.join(distDir, '_worker.js');

const workerSource = `// AUTO-GENERATED by scripts/generate-pages-worker.mjs
// Cloudflare Pages Advanced Mode Worker
// - Provides Decap CMS OAuth endpoints under /api/cms-oauth/*
// - Serves all other requests from static assets via env.ASSETS.fetch

function html(body) {
  return new Response(
    \`<!doctype html><html><head><meta charset="utf-8"></head><body>\${body}</body></html>\`,
    {
      headers: {
        'content-type': 'text/html; charset=utf-8',
        'cache-control': 'no-store',
      },
    },
  );
}

function safeJsonParseBase64(input) {
  try {
    if (!input) return null;
    return JSON.parse(atob(input));
  } catch {
    return null;
  }
}

async function handleCmsOauthAuth(request, env) {
  const url = new URL(request.url);
  const origin = url.searchParams.get('origin') || '';
  const siteId = url.searchParams.get('site_id') || '';

  const clientId = env.GITHUB_CLIENT_ID;
  if (!clientId) return new Response('Missing env.GITHUB_CLIENT_ID', { status: 500 });

  const callbackUrl = new URL('/api/cms-oauth/callback', url.origin);
  const state = btoa(
    JSON.stringify({
      origin,
      siteId,
      ts: Date.now(),
      nonce: crypto.randomUUID(),
    }),
  );

  const authUrl = new URL('https://github.com/login/oauth/authorize');
  authUrl.searchParams.set('client_id', clientId);
  authUrl.searchParams.set('redirect_uri', callbackUrl.toString());
  authUrl.searchParams.set('scope', 'repo');
  authUrl.searchParams.set('state', state);

  return Response.redirect(authUrl.toString(), 302);
}

async function handleCmsOauthCallback(request, env) {
  const url = new URL(request.url);
  const code = url.searchParams.get('code');
  const error = url.searchParams.get('error');
  const stateRaw = url.searchParams.get('state');

  if (error) return html(\`<p>OAuth error: \${error}</p>\`);
  if (!code) return html('<p>Missing OAuth code.</p>');

  const clientId = env.GITHUB_CLIENT_ID;
  const clientSecret = env.GITHUB_CLIENT_SECRET;
  if (!clientId || !clientSecret) {
    return new Response('Missing GITHUB_CLIENT_ID/GITHUB_CLIENT_SECRET', { status: 500 });
  }

  const state = safeJsonParseBase64(stateRaw);
  const origin = state?.origin || url.origin;

  const tokenRes = await fetch('https://github.com/login/oauth/access_token', {
    method: 'POST',
    headers: {
      'content-type': 'application/json',
      accept: 'application/json',
      'user-agent': 'decap-cms-oauth-proxy',
    },
    body: JSON.stringify({
      client_id: clientId,
      client_secret: clientSecret,
      code,
    }),
  });

  if (!tokenRes.ok) {
    const text = await tokenRes.text();
    return html(\`<p>Token exchange failed.</p><pre>\${text}</pre>\`);
  }

  const tokenJson = await tokenRes.json();
  const token = tokenJson.access_token;
  if (!token) {
    return html(\`<p>Missing access_token in response.</p><pre>\${JSON.stringify(tokenJson, null, 2)}</pre>\`);
  }

  const payload = { token, provider: 'github' };
  const script = \`
    (function () {
      var origin = \${JSON.stringify(origin)};
      var payload = \${JSON.stringify(payload)};

      function post(msg) {
        try {
          window.opener && window.opener.postMessage(msg, origin);
        } catch (e) {}
      }

      // Common formats used by Netlify/Decap auth flows
      post('authorization:github:success:' + payload.token);
      post({ type: 'authorization:github:success', token: payload.token, provider: 'github' });
      post({ token: payload.token, provider: 'github' });

      window.close();
    })();
  \`;

  return html(\`<script>\${script}</script><p>Authorised. You may close this window.</p>\`);
}

export default {
  async fetch(request, env) {
    const url = new URL(request.url);

    if (url.pathname === '/api/cms-oauth/auth') {
      return handleCmsOauthAuth(request, env);
    }

    if (url.pathname === '/api/cms-oauth/callback') {
      return handleCmsOauthCallback(request, env);
    }

    // Serve static assets (Pages Advanced Mode requirement)
    return env.ASSETS.fetch(request);
  },
};
`;

await fs.mkdir(distDir, { recursive: true });
await fs.writeFile(outFile, workerSource, 'utf8');

// eslint-disable-next-line no-console
console.log(`Generated ${outFile}`);

